{# Name: Li Ziyang #}
{# BU Email: miclilzy@bu.edu #}
{# File Description: Template for displaying the detailed information of a single F1 circuit, #}
{# including its stats, introduction, fun facts, and a section for viewing and adding comments. #}

{# Extend the base template to inherit common structure and styles #}
{% extends "circuits/base.html" %}
{# Load static files tag library #}
{% load static %}

{# Set the page title specific to this circuit #}
{% block title %}{{ circuit.name }} - F1 Explorer{% endblock %}

{# Start of the main content block specific to this page #}
{% block content %}
  {# === Header === #}
  {# Display the circuit's name as the main heading #}
  <h1>{{ circuit.name }}</h1>
  {# Display the circuit's location #}
  <p class="text-muted">Location: {{ circuit.location }}</p>

  {# === Image + Introduction === #}
  {# Container for layout image and introduction text #}
  <div class="circuit-detail">
    {# Circuit layout image section #}
    <div class="circuit-detail__image">
      <img src="{{ circuit.layout_image.url }}" alt="{{ circuit.name }} layout">
    </div>
    {# Circuit introduction text section #}
    <div class="circuit-detail__intro">
      <h2>Introduction</h2>
      <p>{{ circuit.introduction }}</p>
    </div>
  </div>

  {# === Stats Grid === #}
  {# Grid container for displaying key circuit statistics #}
  <div class="stats-grid">
    {# Stat card for First Grand Prix year #}
    <div class="stat-card">
      <h4>First Grand Prix</h4>
      <p class="stat-value">{{ circuit.first_grand_prix }}</p>
    </div>
    {# Stat card for Number of Laps #}
    <div class="stat-card">
      <h4>Number of Laps</h4>
      <p class="stat-value">{{ circuit.number_of_laps }}</p>
    </div>
    {# Stat card for Circuit Length #}
    <div class="stat-card">
      <h4>Circuit Length</h4>
      <p class="stat-value">{{ circuit.circuit_length }} km</p>
    </div>
    {# Stat card for Race Distance #}
    <div class="stat-card">
      <h4>Race Distance</h4>
      <p class="stat-value">{{ circuit.race_distance }} km</p>
    </div>
    {# Wide stat card for Lap Record information #}
    <div class="stat-card stat-card--wide">
      <h4>Lap Record</h4>
      <p class="stat-value">{{ circuit.record_lap_info }}</p>
    </div>
  </div>

  {# === Fun Fact Panel === #}
  {# Conditionally display the fun fact section if fun_fact exists #}
  {% if circuit.fun_fact %}
    <div class="fun-fact-section detail-section">
      <h2><i class="fas fa-lightbulb"></i> Fun Fact</h2> {# Example icon (assuming FontAwesome) #}
      <p>{{ circuit.fun_fact }}</p>
    </div>
  {% endif %}
  
  {# Visual separator before the comments section #}
  <hr>

  {# === Comments Section === #}
  <div class="comments-section">
    {# Heading for the comments section #}
    <h3>Comments</h3>

    {# --- Comment Form Section --- #}
    {# Display comment form only if the user is authenticated #}
    {% if user.is_authenticated %}
      {# Form points to the add_comment view for this circuit #}
      <form class="comment-form" method="post" action="{% url 'circuits:add_comment' circuit.pk %}">
        {% csrf_token %} {# Include CSRF token for security #}
        {# Comment text input field #}
        <div class="mb-3">
          <label for="{{ form.text.id_for_label }}">{{ form.text.label }}</label>
          {{ form.text }} {# Render the textarea widget #}
        </div>
        {# Comment rating input field #}
        <div class="mb-3">
          <label for="{{ form.rating.id_for_label }}">{{ form.rating.label }}</label>
          {{ form.rating }} {# Render the select widget #}
          {# Display help text for the rating field if available #}
          {% if form.rating.help_text %}
            <small class="form-text text-muted">{{ form.rating.help_text }}</small>
          {% endif %}
        </div>
        {# Submit button for the comment form #}
        <button type="submit" class="btn btn-primary btn-submit-comment">Submit Comment</button>
      </form>
    {# If user is not logged in, show a prompt to log in #}
    {% else %}
      <p class="text-muted">
        Please <a href="{% url 'login' %}">log in</a> to leave a comment.
      </p>
    {% endif %}
    {# --- End Comment Form Section --- #}

    {# --- Display Existing Comments --- #}
    {# Loop through all comments related to this circuit #}
    {% for comment in circuit.comments.all %}
      {# Card container for displaying a single comment #}
      <div class="comment-card mb-3">
        <div class="comment-card-body">
          {# Comment metadata: Author username and creation timestamp #}
          <div class="meta">
            <strong>{{ comment.user.username }}</strong>
            <small>{{ comment.created_at|date:"Y-m-d H:i" }}</small> {# Format the date/time #}
          </div>
          {# The actual text content of the comment #}
          <p class="text">{{ comment.text }}</p>
          {# The rating given by the user #}
          <p class="rating">Rating: {{ comment.rating }} â˜…</p> {# Display rating with a star symbol #}

          {# --- Comment Actions (Edit/Delete) --- #}
          {# Show edit/delete buttons only if the current user is the comment author #}
          {% if comment.user == user %}
            <div class="actions">
              {# Link to the comment update view #}
              <a
                href="{% url 'circuits:comment_update' comment.pk %}"
                class="btn btn-edit" {# Apply custom styling #}
              >Edit</a>
              {# Link to the comment delete view #}
              <a
                href="{% url 'circuits:comment_delete' comment.pk %}"
                class="btn btn-delete" {# Apply custom styling #}
              >Delete</a>
            </div>
          {% endif %}
          {# --- End Comment Actions --- #}
        </div>
      </div>
    {# If there are no comments for this circuit #}
    {% empty %}
      <p class="text-muted">
        No comments yet. Be the first to share your thoughts!
      </p>
    {% endfor %}
    {# --- End Display Existing Comments --- #}
  </div>
  {# === End Comments Section === #}
{% endblock content %}
{# End of the main content block #}